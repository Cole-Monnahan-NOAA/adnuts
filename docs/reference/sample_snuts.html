<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts • adnuts</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts"><meta name="description" content="NUTS sampling for TMB models using a sparse metric (BETA)."><meta property="og:description" content="NUTS sampling for TMB models using a sparse metric (BETA)."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">adnuts</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/adnuts.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/NUTS-for-ADMB-models.html">NUTS for ADMB models</a></li>
    <li><a class="dropdown-item" href="../articles/SNUTS-for-TMB-models.html">Sparse NUTS for TMB models</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Cole-Monnahan-NOAA/adnuts/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NUTS sampling for TMB models using a sparse metric (BETA).</h1>
      <small class="dont-index">Source: <a href="https://github.com/Cole-Monnahan-NOAA/adnuts/blob/HEAD/R/sample_snuts.R" class="external-link"><code>R/sample_snuts.R</code></a></small>
      <div class="d-none name"><code>sample_snuts.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>NUTS sampling for TMB models using a sparse metric (BETA).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">sample_snuts</span><span class="op">(</span></span>
<span>  <span class="va">obj</span>,</span>
<span>  num_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  num_warmup <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  cores <span class="op">=</span> <span class="va">chains</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  adapt_stan_metric <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  control <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  laplace <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"last.par.best"</span>, <span class="st">"random"</span>, <span class="st">"random-t"</span>, <span class="st">"unif"</span><span class="op">)</span>,</span>
<span>  metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"auto"</span>, <span class="st">"unit"</span>, <span class="st">"diag"</span>, <span class="st">"dense"</span>, <span class="st">"sparse"</span>, <span class="st">"stan"</span>, <span class="st">"sparse-naive"</span><span class="op">)</span>,</span>
<span>  skip_optimization <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  Q <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Qinv <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  globals <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  model_name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  refresh <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  print <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  rotation_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  warmup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-obj">obj<a class="anchor" aria-label="anchor" href="#arg-obj"></a></dt>
<dd><p>The TMB object with random effects turned on and
optimized.</p></dd>


<dt id="arg-num-samples">num_samples<a class="anchor" aria-label="anchor" href="#arg-num-samples"></a></dt>
<dd><p>The number of post-warmup iterations to
run per chain.</p></dd>


<dt id="arg-num-warmup">num_warmup<a class="anchor" aria-label="anchor" href="#arg-num-warmup"></a></dt>
<dd><p>The number of warmup iterations to run per
chain. The default of NULL indicates to automatically
determine it based on other settings (recommended).</p></dd>


<dt id="arg-chains">chains<a class="anchor" aria-label="anchor" href="#arg-chains"></a></dt>
<dd><p>Number of chains</p></dd>


<dt id="arg-cores">cores<a class="anchor" aria-label="anchor" href="#arg-cores"></a></dt>
<dd><p>Number of parallel cores to use, defaults to
<code>chains</code> so set this to 1 to execute serial chains.</p></dd>


<dt id="arg-thin">thin<a class="anchor" aria-label="anchor" href="#arg-thin"></a></dt>
<dd><p>The thinning rate (defaults to 1).</p></dd>


<dt id="arg-adapt-stan-metric">adapt_stan_metric<a class="anchor" aria-label="anchor" href="#arg-adapt-stan-metric"></a></dt>
<dd><p>A boolean whether Stan should engage
diagonal mass matrix adaptation. The default of NULL
indicates to automatically select depending on other
settings. See details.</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>NUTS control list, currently available options
are 'adapt_delta', 'max_treedepth', and 'metric' which is
the type of metric adaptation for Stan to do with options
('unit_e', 'diag_e', or 'dense_e'). For dense and sparse
metrics this usually can be 'unit_e' to skip adaptation.
NULL values (default) revert to <code>stan_sample</code> defaults.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Random number seed, used for generating initial
values (if 'random") and for NUTS.</p></dd>


<dt id="arg-laplace">laplace<a class="anchor" aria-label="anchor" href="#arg-laplace"></a></dt>
<dd><p>Whether to leave the Laplace approximation on
and only use NUTS to sample the fixed effects, or turn it
off and sample from the joint parameter space (default).</p></dd>


<dt id="arg-init">init<a class="anchor" aria-label="anchor" href="#arg-init"></a></dt>
<dd><p>Either 'last.par.best' (default), 'random',
'random-t', or 'unif'. The former starts from the joint
mode, while 'random' and 'random-t' draw from multivariate
normal or multivariate t with 2 degrees of freedom
distributions using the inverse joint precision matrix as a
covariance matrix. 'random-t' is provided to allow for more
dispersed initial values. 'unif' will draw U(-2,2) samples
for all parameters, similar ot Stan's default behavior. If
the joint NLL is undefined at the initial values then the
model will exit and return the initial vector for further
investigation by the user, if desired. Note that
<code><a href="https://rdrr.io/pkg/StanEstimators/man/stan_sample.html" class="external-link">StanEstimators::stan_sample</a></code> only allows for
the same init vector for all chains currently. If a seed is
specified it will be set and thus the inits used will be
reproducible. The inits are also returned in the 'inits'
slot of the fitted object.</p></dd>


<dt id="arg-metric">metric<a class="anchor" aria-label="anchor" href="#arg-metric"></a></dt>
<dd><p>A character specifying which metric to use.
Defaults to "auto" which uses an algorithm to select the
best metric (see details), otherwise one of "sparse",
"dense", "diag", "unit", "Stan", or "sparse-naive" can be
specified.</p></dd>


<dt id="arg-skip-optimization">skip_optimization<a class="anchor" aria-label="anchor" href="#arg-skip-optimization"></a></dt>
<dd><p>Whether to skip optimization or not
(default).</p></dd>


<dt id="arg-q">Q<a class="anchor" aria-label="anchor" href="#arg-q"></a></dt>
<dd><p>The sparse precision matrix. It is calculated
internally if not specified (default).</p></dd>


<dt id="arg-qinv">Qinv<a class="anchor" aria-label="anchor" href="#arg-qinv"></a></dt>
<dd><p>The dense matrix (M). It is calculated internally
if not specified (default).</p></dd>


<dt id="arg-globals">globals<a class="anchor" aria-label="anchor" href="#arg-globals"></a></dt>
<dd><p>A named list of objects to pass to new R
sessions when running in parallel and using RTMB. Typically
this is the `data` object for now.</p></dd>


<dt id="arg-model-name">model_name<a class="anchor" aria-label="anchor" href="#arg-model-name"></a></dt>
<dd><p>An optional character giving the model name.
If NULL it will use the DLL name which for RTMB models is
just 'RTMB'. The name is used only for printing.</p></dd>


<dt id="arg-refresh">refresh<a class="anchor" aria-label="anchor" href="#arg-refresh"></a></dt>
<dd><p>How often to print updates to console
(integer). 0 will turn off printing. The default is 100.</p></dd>


<dt id="arg-print">print<a class="anchor" aria-label="anchor" href="#arg-print"></a></dt>
<dd><p>Whether to print summary of run (default) or not</p></dd>


<dt id="arg-rotation-only">rotation_only<a class="anchor" aria-label="anchor" href="#arg-rotation-only"></a></dt>
<dd><p>Whether to return only the rotation object
(for debugging purposes)</p></dd>


<dt id="arg-iter">iter<a class="anchor" aria-label="anchor" href="#arg-iter"></a></dt>
<dd><p>(Deprecated) Total iterations to run (warmup + sampling)</p></dd>


<dt id="arg-warmup">warmup<a class="anchor" aria-label="anchor" href="#arg-warmup"></a></dt>
<dd><p>(Deprecated) Total warmup iterations. Defaults to
<code>iter</code>/2 based on Stan defaults, but when using dense,
sparse, or diag metrics a much shorter warmup can be used
(e.g., 150), especially if paired with a 'unit_e' Stan
metric. Use <code><a href="plot_sampler_params.html">plot_sampler_params</a></code> to investigate
warmup performance and adjust as necessary for subsequent
runs.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments to pass to
<code><a href="https://rdrr.io/pkg/StanEstimators/man/stan_sample.html" class="external-link">StanEstimators::stan_sample</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A fitted MCMC object of class 'adfit'</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <strong>TMB metric</strong> is used to decorrelate and descale the posterior
distribution before sampling with Stan's algorithms. The chosen metric
and the reasoning for its selection are printed to the console before
sampling begins.</p>
<p><strong>Metric Options</strong></p><ul><li><p><code>'auto'</code>: This is the default setting. It uses an internal
   algorithm to determine the optimal metric for the model. The choice
   depends on the availability of the precision matrix (\(Q\)) and/or
   the covariance matrix (\(M=Q^{-1}\)), the extent of parameter
   correlations, and the speed of gradient calculations.</p></li>
<li><p><code>'dense'</code> and <code>'sparse'</code>: Both of these options
   decorrelate and descale the posterior. However, the
   <code>'sparse'</code> metric is more computationally efficient
   for models with high-dimensional, sparse precision matrices.
   For models without random effects the <code>'sparse'</code> option
   is not available</p></li>
<li><p><code>'diag'</code>: This option only descales the posterior, using the
   marginal standard deviations derived from the covariance matrix
   \(M\). It does not account for correlations.</p></li>
<li><p><code>'unit'</code>: This option uses an identity matrix, which is the
   default behavior in Stan. Unlike the <code>'Stan'</code> option below, the
   model is still optimized to find the mode, and the \(Q\) matrix is
   calculated. This ensures that a full <code>mle</code> object (containing the
   mode, standard errors, and correlations) is returned.</p></li>
<li><p><code>'sparse-naive'</code>: This metric is constructed to be
   mathematically equivalent to <code>'dense'</code> but is often
   computationally faster. It is generally recommended only for testing
   and exploration.</p></li>
<li><p><code>'stan'</code>: This is a special flag that reverts the sampler to
   the standard Stan behavior. It skips the optimization and all \(Q\)
   matrix calculations and ensures that Stan's mass matrix adaptation is
   engaged during warmup.</p></li>
</ul><p><strong>Important Distinction</strong></p>
<p>Note that the <code>metric</code> parameter described here is
specific to <strong>TMB</strong> and is distinct from the Stan metric,
which is controlled via the <code>control</code> list argument in
the sampling function. Stan by default adapts a diagonal mass
matrix (metric_e) using a series of expanding windows. If Q is
a good estimate of the global covariance then this is not
needed and disabling Stan's metric adaptation is recommended.
This can be done by setting `adapt_stan_metric=FALSE`. If left
at NULL Stan's adaptation will only be done for metrics 'stan'
and 'unit' because those two options do not descale the
posterior. In this case, it is recommended to use a longer
warmup period to account for this adaptive procedure.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Cole Monnahan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

